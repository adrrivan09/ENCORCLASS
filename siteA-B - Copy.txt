
lab2:
create a site to site ipsec vpn tunnel between siteA with wan of 10.1.1.1/30 and LAN A one of 172.16.10.1/24 
and siteB with wan of 10.1.1.5/30 and LAN B two of 172.16.20.1/24.

IKE Phase 1 – Routers exchange keys securely (like a private handshake).
IKE Phase 2 – They agree on how to encrypt real data (the “data tunnel”).
Crypto Map – Tells router which traffic to encrypt (based on ACL).
IPsec SA (Security Association) – The live, active tunnel where packets get encrypted.
Encapsulation – Each packet from LAN A → LAN B gets wrapped (encrypted) before it leaves the WAN.


siteA:
conf t
hostname PNBAlabang
!
interface Ethernet1/1
 description WAN to SiteB
 ip address 10.1.1.1 255.255.255.252
 no shutdown
!
interface Ethernet1/0 
 description LAN A
 ip address 172.16.10.1 255.255.255.0
 no shutdown
!
ip route 0.0.0.0 0.0.0.0 10.1.1.2   ! Default route to internet
!
access-list 110 permit ip 172.16.10.0 0.0.0.255 172.16.20.0 0.0.0.255
!phase1
crypto isakmp policy 10
 encr aes          ! Encryption algorithm (AES)
 hash sha256       ! Hash algorithm
 authentication pre-share
 group 14          ! DH group for key exchange
 lifetime 86400
!
crypto isakmp key VPN123 address 10.1.1.5
!
!ike phase2
crypto ipsec transform-set MYSET esp-aes esp-sha-hmac
 mode tunnel
!
!This ties everything together:
! peer, interesting traffic, and transform-set.
!
crypto map VPN-MAP 10 ipsec-isakmp
 set peer 10.1.1.5
 set transform-set MYSET
 match address 110
!
interface Ethernet1/1
 crypto map VPN-MAP
 !
!If you have no dynamic routing, add static routes for the opposite LAN:
ip route 172.16.20.0 255.255.255.0 10.1.1.5
!
end

PNBAlabang#SH CRYpto ISakmp SA
IPv4 Crypto ISAKMP SA
dst             src             state          conn-id status
10.1.1.5        10.1.1.1        QM_IDLE           1001 ACTIVE


siteB
config t
hostname PNB-Bgc
!
interface Ethernet1/3
 description WAN to SiteA
 ip address 10.1.1.5 255.255.255.252
 no shutdown
!
interface Ethernet1/0
 description LAN B
 ip address 172.16.20.1 255.255.255.0
 no shutdown
!
ip route 0.0.0.0 0.0.0.0 10.1.1.6   ! Default route to internet
!
access-list 110 permit ip 172.16.20.0 0.0.0.255 172.16.10.0 0.0.0.255
!ike phase 1
crypto isakmp policy 10
 encr aes
 hash sha256
 authentication pre-share
 group 14
 lifetime 86400
!
crypto isakmp key VPN123 address 10.1.1.1
!
!ike phase2
crypto ipsec transform-set MYSET esp-aes esp-sha-hmac
 mode tunnel
!
!This ties everything together:
! peer, interesting traffic, and transform-set.
crypto map VPN-MAP 10 ipsec-isakmp
 set peer 10.1.1.1
 set transform-set MYSET
 match address 110
!
interface Ethernet1/3
 crypto map VPN-MAP
!
!If you have no dynamic routing, add static routes for the opposite LAN:
ip route 172.16.10.0 255.255.255.0 10.1.1.1
!
end

CHECKING:
PNB-Bgc#show crypto isakmp sa
IPv4 Crypto ISAKMP SA
dst             src             state          conn-id status
10.1.1.5        10.1.1.1        QM_IDLE           1001 ACTIVE

IPv6 Crypto ISAKMP SA

PNB-Bgc#

##################################################################
##################################################################

classic CCNP-level “GRE over IPsec” site-to-site VPN setup.
It combines GRE (Generic Routing Encapsulation) and IPsec encryption so that:
You get routing protocols + multiprotocol support via GRE,

And encryption/authentication via IPsec:

BPIalabang:
config t
hostname BPIalabang
!
interface Ethernet1/1
 description WAN to SiteB
 ip address 10.1.1.1 255.255.255.252
 no shutdown
!
interface Ethernet1/0
 description LAN A
 ip address 172.16.10.1 255.255.255.0
 no shutdown
!
ip route 0.0.0.0 0.0.0.0 10.1.1.2   ! Default route to Internet
!
!Configure GRE Tunnel
!
interface Tunnel0
 description GRE Tunnel to SiteB
 ip address 192.168.100.1 255.255.255.252
 ip mtu 1400
 tunnel source 10.1.1.1
 tunnel destination 10.1.1.5
 keepalive 10 3
 no shutdown
!
access-list 110 permit gre host 10.1.1.1 host 10.1.1.5
!
!Configure ISAKMP (IKE Phase 1)
!
crypto isakmp policy 10
 encr aes
 hash sha256
 authentication pre-share
 group 14
 lifetime 86400
!
crypto isakmp key GREVPN123 address 10.1.1.5
!
!Define the IPsec Transform Set (Phase 2)
!
crypto ipsec transform-set GRE-SET esp-aes esp-sha-hmac
 mode transport
!
!Create and Apply Crypto Map
!
crypto map GRE-MAP 10 ipsec-isakmp
 set peer 10.1.1.5
 set transform-set GRE-SET
 match address 110
!
interface Ethernet1/1
 crypto map GRE-MAP
!
!Now, GRE traffic between 10.1.1.1 and 10.1.1.5 will be encrypted by IPsec.
!
!use static routing or a dynamic protocol (like OSPF).
!Let’s use static routes for simplicity.
!
ip route 172.16.20.0 255.255.255.0 192.168.100.2
!
!

BPI-BGc:
config t
hostname BPI-BGc
!
interface Ethernet1/3 
 description WAN to SiteA
 ip address 10.1.1.5 255.255.255.252
 no shutdown
!
interface Ethernet1/0
 description LAN B
 ip address 172.16.20.1 255.255.255.0
 no shutdown
!
ip route 0.0.0.0 0.0.0.0 10.1.1.6   ! Default route to Internet
!
!Configure GRE Tunnel
!
interface Tunnel0
 description GRE Tunnel to SiteA
 ip address 192.168.100.2 255.255.255.252
 ip mtu 1400
 tunnel source 10.1.1.5
 tunnel destination 10.1.1.1
 keepalive 10 3
 no shutdown
!
access-list 110 permit gre host 10.1.1.5 host 10.1.1.1
!
!Configure ISAKMP (IKE Phase 1)
!
crypto isakmp policy 10
 encr aes
 hash sha256
 authentication pre-share
 group 14
 lifetime 86400
!
crypto isakmp key GREVPN123 address 10.1.1.1
!
!Define the IPsec Transform Set (Phase 2)
!
crypto ipsec transform-set GRE-SET esp-aes esp-sha-hmac
 mode transport
!
!Create and Apply Crypto Map
!
crypto map GRE-MAP 10 ipsec-isakmp
 set peer 10.1.1.1
 set transform-set GRE-SET
 match address 110
!
interface Ethernet1/3
 crypto map GRE-MAP
!
!Now, GRE traffic between 10.1.1.1 and 10.1.1.5 will be encrypted by IPsec.
!
!use static routing or a dynamic protocol (like OSPF).
!Let’s use static routes for simplicity.
!
ip route 172.16.10.0 255.255.255.0 192.168.100.1
!

TEST:
BPIalabang#ping 172.16.20.1 source 172.16.10.1 re 100  
Type escape sequence to abort.
Sending 100, 100-byte ICMP Echos to 172.16.20.1, timeout is 2 seconds:
Packet sent with a source address of 172.16.10.1 
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
Success rate is 100 percent (100/100), r

BPIalabang#show crypto isakmp sa                       
IPv4 Crypto ISAKMP SA
dst             src             state          conn-id status
10.1.1.5        10.1.1.1        QM_IDLE           1002 ACTIVE
10.1.1.1        10.1.1.5        QM_IDLE           1001 ACTIVE

IPv6 Crypto ISAKMP SA

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
the modern Cisco VPN method: a Virtual Tunnel Interface (VTI) IPsec
site-to-site VPN.
VTI is easier and cleaner than crypto maps or GRE/IPsec because:
a. It acts like a normal interface (with an IP address).
b. Supports routing protocols (OSPF, BGP, EIGRP) directly.
c. Simpler configuration and troubleshooting.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

BSPalabang:

config t
! ---------- SiteA ----------
hostname BSPalabang

interface Ethernet0/1
 description WAN-to-SiteB
 ip address 10.1.1.1 255.255.255.252
 no shutdown

interface Ethernet0/0
 description LAN-A
 ip address 172.16.10.1 255.255.255.0
 no shutdown

! IKEv2 keying
crypto ikev2 proposal VTI-PROP
 encryption aes-cbc-256
 integrity sha256
 group 14

crypto ikev2 policy VTI-POLICY
 proposal VTI-PROP

crypto ikev2 keyring VTI-KEYS
 peer SITEB
  address 10.1.1.5
  pre-shared-key local VTI123
  pre-shared-key remote VTI123

crypto ikev2 profile VTI-IKEV2
 match identity remote address 10.1.1.5 255.255.255.255
 authentication local pre-share
 authentication remote pre-share
 keyring local VTI-KEYS

! IPsec
crypto ipsec transform-set VTI-SET esp-aes 256 esp-sha256-hmac
 mode tunnel

crypto ipsec profile VTI-PROFILE
 set transform-set VTI-SET
 set ikev2-profile VTI-IKEV2

! VTI interface
interface Tunnel0
 description VTI to SiteB
 ip address 192.168.100.1 255.255.255.252
 tunnel source 10.1.1.1
 tunnel destination 10.1.1.5
 tunnel mode ipsec ipv4
 tunnel protection ipsec profile VTI-PROFILE
 ip mtu 1400
 no shutdown

! Route to remote LAN via the tunnel
ip route 172.16.20.0 255.255.255.0 192.168.100.2
!
end


config t
! ---------- SiteB ----------
hostname BSPbgc

interface Ethernet0/1
 description WAN-to-SiteA
 ip address 10.1.1.5 255.255.255.252
 no shutdown

interface Ethernet0/0
 description LAN-B
 ip address 172.16.20.1 255.255.255.0
 no shutdown

! IKEv2 keying (mirror of SiteA)
crypto ikev2 proposal VTI-PROP
 encryption aes-cbc-256
 integrity sha256
 group 14

crypto ikev2 policy VTI-POLICY
 proposal VTI-PROP

crypto ikev2 keyring VTI-KEYS
 peer SITEA
  address 10.1.1.1
  pre-shared-key local VTI123
  pre-shared-key remote VTI123

crypto ikev2 profile VTI-IKEV2
 match identity remote address 10.1.1.1 255.255.255.255
 authentication local pre-share
 authentication remote pre-share
 keyring local VTI-KEYS

! IPsec
crypto ipsec transform-set VTI-SET esp-aes 256 esp-sha256-hmac
 mode tunnel

crypto ipsec profile VTI-PROFILE
 set transform-set VTI-SET
 set ikev2-profile VTI-IKEV2

! VTI interface
interface Tunnel0
 description VTI to SiteA
 ip address 192.168.100.2 255.255.255.252
 tunnel source 10.1.1.5
 tunnel destination 10.1.1.1
 tunnel mode ipsec ipv4
 tunnel protection ipsec profile VTI-PROFILE
 ip mtu 1400
 no shutdown

! Route to remote LAN via the tunnel
ip route 172.16.10.0 255.255.255.0 192.168.100.1
!
!


BSPalabang#show crypto ikev2 sa
 IPv4 Crypto IKEv2  SA 

Tunnel-id Local                 Remote                fvrf/ivrf            Status 
2         10.1.1.1/500          10.1.1.5/500          none/none            READY  
      Encr: AES-CBC, keysize: 256, PRF: SHA256, Hash: SHA256, DH Grp:14, Auth sign: PSK, Auth verify: PSK
      Life/Active Time: 86400/64 sec

 IPv6 Crypto IKEv2  SA 
